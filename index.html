<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Diary ng Pangeet</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<!-- Google Font: Baloo 2 -->
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Baloo 2', cursive, sans-serif;
  background: linear-gradient(to bottom, #87CEEB, #00BFFF);
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  overflow-x: hidden;
}

/* Panels */
.panel {
  position: relative;
  width: 93%;
  max-width: 700px;
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(10px);
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 25px;
  box-shadow: 0px 8px 18px rgba(0,0,0,0.2);
  padding: 25px;
  margin-bottom: 20px;
  overflow: hidden;
  box-sizing: border-box;
}

.panel::before {
  content: "";
  position: absolute;
  inset: 0;
  background-image: url("https://i.pinimg.com/236x/02/02/e9/0202e9798ea447ad13dc5e83bbc6e6b3.jpg");
  background-size: cover;
  background-position: center;
  opacity: 0.1;
  z-index: 0;
}

.panel * { position: relative; z-index: 1; }

h1 {
  color: #ffcc00;
  text-shadow: 2px 2px #000;
  text-align: center;
  margin-bottom: 20px;
  font-size: 2em;
}

input[type="email"], input[type="password"], input[type="text"], textarea {
  width: 100%;
  padding: 12px;
  margin-bottom: 10px;
  border: 3px solid #ffcc00;
  border-radius: 20px;
  font-size: 15px;
  box-sizing: border-box;
  font-family: 'Baloo 2', cursive, sans-serif;
}

textarea {
  height: 130px;
  resize: none;
  background: #fffacd;
  box-shadow: inset 0px 2px 8px rgba(0,0,0,0.1);
}

.preview { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px; }
.preview div { position: relative; display: inline-block; }
.preview img { max-width: 100px; max-height: 100px; border-radius: 15px; border: 3px dashed #ffcc00; }

.remove-img {
  position: absolute;
  top: 2px;
  right: 2px;
  background: red;
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 12px;
  cursor: pointer;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0px 2px 4px rgba(0,0,0,0.3);
}

button {
  margin-top: 10px;
  background: #ffcc00;
  border: none;
  color: #000;
  padding: 12px 25px;
  border-radius: 25px;
  cursor: pointer;
  font-weight: bold;
  transition: 0.3s;
  box-shadow: 0 0 5px #ffcc00, 0 0 10px #ffcc00;
}
button:hover {
  box-shadow: 0 0 20px #ffcc00, 0 0 40px #ffcc00;
  background: #f6e05e;
}

/* Character counter */
.char-counter {
  font-size: 12px;
  color: #555;
  text-align: right;
  margin-top: -8px;
  margin-bottom: 8px;
}

/* Timeline Entries */
.entries {
  margin-top: 10px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  position: relative;
  z-index: 1;
  max-height: 400px;
  overflow-y: auto;
}
.entries::-webkit-scrollbar { width: 10px; }
.entries::-webkit-scrollbar-track { background: rgba(255,255,255,0.2); border-radius: 10px; }
.entries::-webkit-scrollbar-thumb { background: #ffcc00; border-radius: 10px; box-shadow: inset 0 0 5px rgba(0,0,0,0.2); }

.entry {
  position: relative;
  background: linear-gradient(to bottom, #fffacd, #fff5b1);
  border-left: 6px solid #ffcc00;
  border-radius: 12px;
  padding: 15px;
  word-wrap: break-word;
  box-shadow: 0px 4px 14px rgba(0,0,0,0.2);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.entry-header {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
}
.entry-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #ffcc00 center/cover no-repeat;
  margin-right: 10px;
  border: 2px solid #fff;
}
.entry-user { font-weight: bold; color: #ffcc00; text-shadow: 1px 1px #000; }
.entry-date { font-size: 12px; color: #444; margin-left: auto; background: #fffacd; border: 2px solid #ffcc00; border-radius: 20px; padding: 4px 10px; box-shadow: 2px 2px 4px rgba(0,0,0,0.3); }

.entry-buttons { margin-top: 10px; display: flex; gap: 10px; justify-content: flex-end; }
.entry-buttons button { background: #ffcc00; border: none; border-radius: 15px; padding: 6px 12px; cursor: pointer; font-size: 0.85em; transition: 0.2s; }
.entry-buttons button:hover { background: #f6e05e; }

#diaryButtons { display:flex; justify-content: space-between; flex-wrap: wrap; gap:10px; }

/* Mobile adjustments */
@media (max-width: 600px) {
  .panel { width: 100%; height: 100vh; border-radius: 0; padding: 15px; overflow-y: auto; }
  button { padding: 15px; font-size: 16px; }
  #diaryButtons button { width: calc(50% - 10px); }
}
</style>
</head>
<body>

<!-- Authentication Panel -->
<div class="panel" id="authPanel">
  <h1>üîí Login / Register üîí</h1>
  <input type="email" id="email" placeholder="Email">
  <div style="position: relative; width: 100%; margin-bottom: 10px;">
    <input type="password" id="password" placeholder="Password" style="width:100%; padding-right:40px;">
    <button type="button" id="togglePassword" style="
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: #ffcc00;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      cursor: pointer;
      font-size: 16px;
      text-align: center;
      line-height: 28px;
    ">üëÅÔ∏è</button>
  </div>
  <button onclick="login()">Login</button>
  <button onclick="register()">Register</button>
</div>

<!-- Profile Setup Panel -->
<div class="panel" id="profilePanel" style="display:none;">
  <h1>üñåÔ∏è Setup Profile üñåÔ∏è</h1>
  <input type="text" id="displayNameInput" placeholder="Enter username">
  <input type="file" id="profilePhotoInput" accept="image/*">
  <div class="preview" id="profilePreview"></div>
  <button onclick="saveProfile()">Save Profile</button>
</div>

<!-- Diary Panel -->
<div class="panel" id="diaryPanel" style="display:none;">
  <h1>üçç Dear Diary üçç</h1>
  <textarea id="diaryText" placeholder="Write something..." maxlength="500"></textarea>
  <div class="char-counter" id="charCounter">0 / 500</div>
  <input type="file" id="imageInput" accept="image/*" multiple>
  <div class="preview" id="preview"></div>
  <div id="diaryButtons">
    <button onclick="saveEntry()">üì• Save Entry</button>
    <button onclick="logout()">Logout</button>
    <button onclick="editProfile()">‚úèÔ∏è Edit Profile</button>
  </div>
</div>

<!-- Entries Panel -->
<div class="panel" id="entriesPanel" style="display:none;">
  <h1>üìö For Me Page üìö</h1>
  <div class="entries" id="entries"></div>
</div>

<!-- Audio -->
<audio id="sound1" preload="auto"><source src="https://www.myinstants.com/media/sounds/spongebob-bubble.mp3" type="audio/mpeg"></audio>
<audio id="sound2" preload="auto"><source src="https://www.myinstants.com/media/sounds/spongebob-laugh.mp3" type="audio/mpeg"></audio>
<audio id="sound3" preload="auto"><source src="https://www.myinstants.com/media/sounds/spongebob-fail.mp3" type="audio/mpeg"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAmqyE4CxelCoSxEwqPcxkfY-Z3ivyGasA",
  authDomain: "diary-appp.firebaseapp.com",
  projectId: "diary-appp",
  storageBucket: "diary-appp.appspot.com",
  messagingSenderId: "33131635999",
  appId: "1:33131635999:web:7a91f687ff42e0cf93fc2a",
  measurementId: "G-4HF6ZXBQ1K"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

const preview = document.getElementById("preview");
const imageInput = document.getElementById("imageInput");
let imagesData = [];

const profilePreview = document.getElementById("profilePreview");
const profilePhotoInput = document.getElementById("profilePhotoInput");
let profilePhotoData = null;

const diaryText = document.getElementById("diaryText");
const charCounter = document.getElementById("charCounter");
diaryText.addEventListener("input", ()=>{ charCounter.textContent = `${diaryText.value.length} / 500`; });

imageInput.addEventListener("change", function() {
  const files = Array.from(this.files);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const imgSrc = e.target.result;
      imagesData.push(imgSrc);
      const div = document.createElement("div");
      div.innerHTML = `<img src="${imgSrc}"><button class="remove-img">‚úñ</button>`;
      div.querySelector("button").addEventListener("click", ()=>{ imagesData = imagesData.filter(i => i!==imgSrc); div.remove(); });
      preview.appendChild(div);
    }
    reader.readAsDataURL(file);
  });
});

profilePhotoInput.addEventListener("change", function(){
  const file = this.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = function(e){
      profilePhotoData = e.target.result;
      profilePreview.innerHTML = `<img src="${profilePhotoData}" style="max-width:100px;border-radius:50%;">`;
    }
    reader.readAsDataURL(file);
  }
});

window.register = async function() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try {
    await createUserWithEmailAndPassword(auth,email,password);
    alert("Registered! Now set up your profile.");
  } catch(e){ alert(e.message); }
}

window.login = async function() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try { await signInWithEmailAndPassword(auth,email,password); }
  catch(e){ alert(e.message); }
}

window.logout = async function() { await signOut(auth); }

onAuthStateChanged(auth,user=>{
  const authPanel = document.getElementById("authPanel");
  const profilePanel = document.getElementById("profilePanel");
  const diaryPanel = document.getElementById("diaryPanel");
  const entriesPanel = document.getElementById("entriesPanel");
  if(user){
    authPanel.style.display="none";
    if(!user.displayName){
      profilePanel.style.display="block";
    } else {
      diaryPanel.style.display="block";
      entriesPanel.style.display="block";
      displayEntries();
    }
  } else {
    authPanel.style.display="block";
    profilePanel.style.display="none";
    diaryPanel.style.display="none";
    entriesPanel.style.display="none";
  }
});

// --- SAVE PROFILE FIXED ---
async function saveProfile() {
  const displayName = document.getElementById("displayNameInput").value.trim();
  if (!displayName) { alert("Enter a username"); return; }

  let photoURL = auth.currentUser.photoURL || null;

  if (profilePhotoData) {
    const storageRef = ref(storage, `profilePhotos/${auth.currentUser.uid}.png`);
    await uploadString(storageRef, profilePhotoData, 'data_url');
    photoURL = await getDownloadURL(storageRef);
  }

  try {
    await updateProfile(auth.currentUser, { displayName, photoURL });
    document.getElementById("profilePanel").style.display="none";
    document.getElementById("diaryPanel").style.display="block";
    document.getElementById("entriesPanel").style.display="block";
    displayEntries();
    alert("Profile saved successfully!");
  } catch (e) {
    console.error(e);
    alert("Error saving profile: " + e.message);
  }
}

// Edit profile button
function editProfile(){
  document.getElementById("displayNameInput").value = auth.currentUser.displayName || "";
  profilePreview.innerHTML = auth.currentUser.photoURL ? `<img src="${auth.currentUser.photoURL}" style="max-width:100px;border-radius:50%;">` : "";
  document.getElementById("profilePanel").style.display="block";
  document.getElementById("diaryPanel").style.display="none";
  document.getElementById("entriesPanel").style.display="none";
}

// Diary entries (same as your previous working code)
window.saveEntry = async function(){
  const text = diaryText.value.trim();
  if(!text && imagesData.length===0){ alert("Write something or add a picture!"); return; }
  try{
    await addDoc(collection(db,"entries"),{
      text,
      images: imagesData,
      date: new Date().toISOString(),
      userId: auth.currentUser.uid
    });
    diaryText.value=""; charCounter.textContent="0 / 500"; preview.innerHTML=""; imagesData=[];
    displayEntries();
    const sounds = [document.getElementById("sound1"), document.getElementById("sound2"), document.getElementById("sound3")];
    const randomSound = sounds[Math.floor(Math.random()*sounds.length)];
    randomSound.currentTime = 0; randomSound.play().catch(err=>console.log("Audio blocked:",err));
  } catch(e){ console.error(e); }
}

// Delete & edit entries
window.deleteEntry = async function(id){ if(confirm("Are you sure you want to delete this entry?")){ await deleteDoc(doc(db,"entries",id)); displayEntries(); } }
window.editEntry = async function(id){ const newText = prompt("Edit your entry:"); if(newText!==null){ await updateDoc(doc(db,"entries",id),{text:newText}); displayEntries(); } }

function formatDate(dateStr){ return new Date(dateStr).toLocaleString(undefined,{year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}); }

async function displayEntries(){
  const entriesDiv = document.getElementById("entries");
  entriesDiv.innerHTML="";
  const q = query(collection(db,"entries"),where("userId","==",auth.currentUser.uid));
  const snapshot = await getDocs(q);
  const entriesArray = snapshot.docs.map(docSnap=>({id:docSnap.id,...docSnap.data()}));
  entriesArray.sort((a,b)=>new Date(b.date)-new Date(a.date));

  if(entriesArray.length===0){ entriesDiv.innerHTML = "<p style='text-align:center; color:#555;'>No entries yet. Write your first diary entry!</p>"; return; }

  entriesArray.forEach(entry=>{
    const div = document.createElement("div");
    div.classList.add("entry");
    const userAvatar = auth.currentUser.photoURL || "https://via.placeholder.com/40";
    div.innerHTML = `
      <div class="entry-header">
        <div class="entry-avatar" style="background-image:url('${userAvatar}')"></div>
        <div class="entry-user">${auth.currentUser.displayName || "Me"}</div>
        <div class="entry-date">${formatDate(entry.date)}</div>
      </div>
      <div class="entry-text">${entry.text.replace(/\n/g,"<br>")}</div>
      <div class="entry-images">${entry.images.map(img=>`<img src="${img}" style="max-width:100px;margin-top:5px;border-radius:12px;">`).join("")}</div>
      <div class="entry-buttons">
        <button onclick="editEntry('${entry.id}')">‚úèÔ∏è Edit</button>
        <button onclick="deleteEntry('${entry.id}')">‚ùå Delete</button>
      </div>
    `;
    entriesDiv.appendChild(div);
  });
}

// Password toggle
document.getElementById("togglePassword").addEventListener("click", ()=>{
  const passInput = document.getElementById("password");
  passInput.type = passInput.type==="password" ? "text" : "password";
});
</script>

</body>
</html>
